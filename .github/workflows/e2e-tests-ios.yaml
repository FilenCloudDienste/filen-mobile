name: E2E Tests (iOS)

on:
  workflow_dispatch:
    inputs:
      artifact_run_id:
        description: 'ID of the workflow run that produced the .app'
        required: true
      app_name:
        description: 'Name of the .app artifact to download'
        required: true
        default: 'ios-simulator-app-test-1'

jobs:
  maestro-ios:
    runs-on: macos-latest
    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v4

      - name: 🔍 Download .app from specific workflow run
        run: |
          APP_BUNDLE_PATH="./build-artifacts/${{ github.event.inputs.app_name }}.app"

          echo "Downloading artifact '${{ github.event.inputs.app_name }}' from run ID ${{ github.event.inputs.artifact_run_id }}"
          gh run download ${{ github.event.inputs.artifact_run_id }} \
            --name "${{ github.event.inputs.app_name }}" \
            -D ./build-artifacts/${{ github.event.inputs.app_name }}.app

          echo "APP_BUNDLE_PATH=$APP_BUNDLE_PATH" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 🔧 Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH
          echo "MAESTRO_CLI_NO_ANALYTICS=true" >> $GITHUB_ENV

      - name: 🏗 Boot iOS Simulator
        uses: futureware-tech/simulator-action@v4
        with:
          model: 'iPhone 16'

      - name: 📲 Install .app on Simulator
        run: |
          xcrun simctl install booted "$APP_BUNDLE_PATH"

      - name: 🧪 Run Maestro Tests
        run: |
          maestro test .maestro --include-tags=auth -e EMAIL="${{ secrets.FILEN_MOBILE_TEST_EMAIL }}" -e PASSWORD="${{ secrets.FILEN_MOBILE_TEST_PASSWORD }}"

      - name: 📦 Upload Maestro debug output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-debug-output
          path: $HOME/.maestro/tests/
