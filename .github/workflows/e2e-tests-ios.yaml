name: E2E Tests (iOS)

on:
  workflow_dispatch:
    inputs:
      artifact_run_id:
        description: 'ID of the workflow run that produced the .app'
        required: true
      app_name:
        description: 'Name of the .app artifact to download'
        required: true
        default: 'ios-simulator-app-test-1'

jobs:
  maestro-ios:
    runs-on: macos-latest
    steps:
      - name: ðŸ— Setup repo
        uses: actions/checkout@v4

      - name: ðŸ” Download .app from specific workflow run
        run: |
          APP_BUNDLE_PATH="./build-artifacts/${{ github.event.inputs.app_name }}.app"

          echo "Downloading artifact '${{ github.event.inputs.app_name }}' from run ID ${{ github.event.inputs.artifact_run_id }}"
          gh run download ${{ github.event.inputs.artifact_run_id }} \
            --name "${{ github.event.inputs.app_name }}" \
            -D ./build-artifacts/${{ github.event.inputs.app_name }}.app

          echo "APP_BUNDLE_PATH=$APP_BUNDLE_PATH" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: ðŸ— Boot iOS Simulator
        uses: futureware-tech/simulator-action@v4
        with:
          model: 'iPhone 16'

      - name: ðŸ“² Install .app on Simulator
        run: |
          xcrun simctl install booted "$APP_BUNDLE_PATH"

      - name: ðŸŽ¥ Start Simulator Screen Recording
        run: |
          mkdir -p ./simulator-recordings
          xcrun simctl io booted recordVideo ./simulator-recordings/test_run.mp4 &
          echo $! > record_pid.txt  # save PID to stop later

      - name: ðŸ§ª Run Maestro Tests
        run: |
          maestro test .maestro \
            --include-tags=drive
        env:
          MAESTRO_CLI_NO_ANALYTICS: true
          EMAIL: ${{ secrets.FILEN_MOBILE_TEST_EMAIL }}
          PASSWORD: ${{ secrets.FILEN_MOBILE_TEST_PASSWORD }}

      - name: ðŸ›‘ Stop Simulator Screen Recording
        if: always()
        run: |
          kill -INT $(cat record_pid.txt)
          rm record_pid.txt

      - name: ðŸ“¦ Upload Screen Recording
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: simulator-screen-recording
          path: ./simulator-recordings/test_run.mp4

      - name: ðŸ“¦ Upload Maestro debug output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-debug-output
          path: /Users/runner/.maestro/tests/
