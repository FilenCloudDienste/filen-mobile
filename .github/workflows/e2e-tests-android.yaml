name: Run End-to-End Tests (Android)

on:
  workflow_dispatch:
    inputs:
      apk_name:
        description: 'Name of the APK artifact to download'
        required: true
        default: 'android-release-apk-test-1'

jobs:
  run-maestro-tests:
    runs-on: macos-15

    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v4

      - name: 📦 Download APK
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.inputs.apk_name }}
          path: ./build-artifacts

      - name: 🚀 Start Android emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: google_apis
          arch: x86_64
          profile: pixel_4
          script: |
            echo "Android emulator ready"
            APK_PATH=$(ls ./build-artifacts/*.apk | head -n 1)
            echo "Installing APK: $APK_PATH"
            adb install -r "$APK_PATH"

      - name: 🔧 Install Maestro
        run: curl -Ls "https://get.maestro.mobile.dev" | bash

      - name: 🧪 Run Maestro tests
        run: |
          APK_PATH=$(ls ./build-artifacts/*.apk | head -n 1)
          echo "Using APK: $APK_PATH"
          maestro test .maestro
