name: Run End-to-End Tests (Android)

on:
  workflow_dispatch:
    inputs:
      artifact_run_id:
        description: 'ID of the workflow run that produced the APK'
        required: true
      apk_name:
        description: 'Name of the APK artifact to download'
        required: true
        default: 'android-release-apk-test-1'

jobs:
  run-maestro-tests:
    runs-on: ubuntu-latest

    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v4

      - name: 🔍 Download APK from specific workflow run
        run: |
          echo "Downloading artifact '${{ github.event.inputs.apk_name }}' from run ID ${{ github.event.inputs.artifact_run_id }}"
          gh run download ${{ github.event.inputs.artifact_run_id }} \
            --name "${{ github.event.inputs.apk_name }}" \
            -D ./build-artifacts

          echo "APK_PATH=$(ls ./build-artifacts/*.apk | head -n 1)" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 🔧 Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: 🚀 Start Android emulator | Install App | Run Maestro Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 36
          target: google_apis
          arch: x86_64
          profile: pixel_7_pro
          script: |
            echo "Android emulator ready"
            echo "Installing APK: $APK_PATH"
            adb install -r "$APK_PATH"

            echo "Uploading test image to emulator"
            chmod +x .maestro/scripts/upload-test-image-android.sh
            .maestro/scripts/upload-test-image-android.sh

            echo "Running Maestro Tests"
            maestro test .maestro -e EMAIL="${{ secrets.FILEN_MOBILE_TEST_EMAIL }}" -e PASSWORD="${{ secrets.FILEN_MOBILE_TEST_PASSWORD }}"

      - name: 📦 Upload Maestro debug output
        if: always() # Always run, even if previous steps fail
        uses: actions/upload-artifact@v4
        with:
          name: maestro-debug-output
          path: /home/runner/.maestro/tests/
