name: Build app

on:
    release:
        types: [published]
    workflow_dispatch:

jobs:
    build-android:
        runs-on: macos-latest

        steps:
            - name: ðŸ— Setup repo
              uses: actions/checkout@v4

            - name: ðŸ— Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 24

            - name: ðŸ— Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: 17

            - name: ðŸ— Setup Android SDK
              uses: android-actions/setup-android@v3

            - name: ðŸ¦€ Setup Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  profile: minimal
                  override: true

            - name: ðŸ¦€ Install Cargo NDK
              run: cargo install cargo-ndk

            - name: ðŸ¦€ Install Rust targets
              run: |
                  rustup target add aarch64-linux-android
                  rustup target add x86_64-linux-android

            - name: ðŸ”§ Install Expo CLI
              run: npm install -g @expo/cli@latest

            - name: ðŸ”§ Install patch-package
              run: npm install -g patch-package@latest

            - name: ðŸ“¦ Install nodeThread dependencies
              run: cd nodejs-assets/nodejs-project && npm install --force && cd .. && cd ..

            - name: ðŸ“¦ Install main dependencies
              run: npm install --force

            - name: ðŸ” Setup Expo Credentials
              run: |
                  echo "${{ secrets.EXPO_CREDENTIALS }}" | base64 --decode > credentials.json

            - name: ðŸ“¦ Build nodeThread
              run: cd nodejs-assets/nodejs-project && npm run build && cd .. && cd ..

            - name: ðŸ›  Prebuild
              run: |
                  npm run prebuild:ci:android

            - name: ðŸ“± Build Android Release APK & AAB
              run: |
                  cd android && chmod +x ./gradlew && ./gradlew app:bundleRelease && ./gradlew app:assembleRelease && cd ..

            - name: ðŸ§¹ Cleanup
              if: always()
              run: |
                  rm -f android/app/release.keystore
                  rm -f credentials.json

            - name: ðŸ“¤ Upload Release APK
              uses: actions/upload-artifact@v4
              with:
                  name: android-release-apk-${{ github.run_number }}
                  path: android/app/build/outputs/apk/release/*.apk
                  retention-days: 30

            - name: ðŸ“¤ Upload Release AAB
              uses: actions/upload-artifact@v4
              with:
                  name: android-release-aab-${{ github.run_number }}
                  path: android/app/build/outputs/bundle/release/*.aab
                  retention-days: 30

            - name: ðŸ“Š Build Summary
              run: |
                  echo "## ðŸš€ Build Complete!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ðŸ“± Built artifacts:" >> $GITHUB_STEP_SUMMARY

                  if [ -f "android/app/build/outputs/apk/release/app-release.apk" ]; then
                    APK_SIZE=$(du -h "android/app/build/outputs/apk/release/app-release.apk" | cut -f1)
                    echo "- âœ… Release APK (${APK_SIZE})" >> $GITHUB_STEP_SUMMARY
                  fi

                  if [ -f "android/app/build/outputs/bundle/release/app-release.aab" ]; then
                    AAB_SIZE=$(du -h "android/app/build/outputs/bundle/release/app-release.aab" | cut -f1)
                    echo "- âœ… Release AAB (${AAB_SIZE})" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ðŸ“¦ Download artifacts from the Actions tab above" >> $GITHUB_STEP_SUMMARY
                  echo "### ðŸ”— Build #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
